<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ospsuite.parameteridentification">
<title>User guide • ospsuite.parameteridentification</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="User guide">
<meta property="og:description" content="ospsuite.parameteridentification">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ospsuite.parameteridentification</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/user-guide.html">User guide</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>User guide</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification/blob/HEAD/vignettes/user-guide.Rmd" class="external-link"><code>vignettes/user-guide.Rmd</code></a></small>
      <div class="d-none name"><code>user-guide.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="parameter-estimation-problems">Parameter estimation problems<a class="anchor" aria-label="anchor" href="#parameter-estimation-problems"></a>
</h3>
<p>Biosimulation models often include numerical parameters that
determine the outputs of the model. Often, the values of these
parameters are not known in advance and have to be identified by
matching possible model outputs to the observed data. Finding parameter
values that best match the observed data is called <em>parameter
estimation</em>.</p>
<p>The <a href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification" class="external-link">ospsuite.parameteridentification</a> package provides
a class for setting up such tasks based on existing PKML models, mapping
model outputs to observed data and estimating parameters. Below, three
models of increasing complexity are used to demonstrate the
functionality of the package.</p>
</div>
<div class="section level3">
<h3 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h3>
<p>The package includes a <code>PIConfiguration</code> class for storing
and re-using the settings of the parameter identification task.
Currently, the implemented options include:</p>
<ul>
<li><p><code>printEvaluationFeedback</code> (logical) indicates if the
objective function value should be printed at each iteration</p></li>
<li><p><code>targetFunctionType</code> (possible values: lsq, m3)
indicates which objective function should be used to quantify the
difference between observed data and simulated curve. The M3 method from
<a href="https://link.springer.com/article/10.1023/A:1012299115260" class="external-link">Beal,
2001</a> is an objective function that accounts for possible data points
below the lower limit of quantification.</p></li>
<li><p><code>algorithm</code> (possible values: HJKB, BOBYQA, DEoptim)
indicates which of the optimization algorithms should be used. Control
options can be specified as a list and passed to
<code>piConfiguration$algorithmOptions</code>. Currently, the BOBYQA
method (bound optimization by quadratic approximation) is the default
local derivative-based method. For complex problems where the objective
function may lack stable numerical derivatives or may have a large
number of local minima, <code>HJKB</code> for derivative-free
Hooke-Jeeves algorithm or <code>DEoptim</code> for global stochastic
differential evolution algorithm may be more suitable.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piConfiguration</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIConfiguration.html">PIConfiguration</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">piConfiguration</span><span class="op">$</span><span class="va">printEvaluationFeedback</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="aciclovir-model">Aciclovir model<a class="anchor" aria-label="anchor" href="#aciclovir-model"></a>
</h2>
<div class="section level3">
<h3 id="extracting-parameters-from-the-model">Extracting parameters from the model<a class="anchor" aria-label="anchor" href="#extracting-parameters-from-the-model"></a>
</h3>
<p>A sample PKML file with the model is shipped with the package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Aciclovir.pkml"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">simulations</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Aciclovir"</span></span></code></pre></div>
<p>The parameter corresponding to the lipophilicity of aciclovir is
called <code>Aciclovir|Lipophilicity</code> within the model. The
package has a <code>PIParameter</code> class to represent the varying
parameters in the model and store them along with the starting value,
the lower and the upper bounds of the parameter search space.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu">ospsuite</span><span class="fu">::</span><span class="fu"><a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/getParameter.html" class="external-link">getParameter</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span> <span class="st">"Aciclovir|Lipophilicity"</span>, </span>
<span>    container <span class="op">=</span> <span class="va">simulations</span><span class="op">$</span><span class="va">Aciclovir</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The default bounds are 0.1 of the starting parameter value and 10.0
of the starting parameter value, but it is often useful to supply
parameter bounds from previous knowledge:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">10</span></span>
<span><span class="va">parameters</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="fl">10</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reading-observed-data">Reading observed data<a class="anchor" aria-label="anchor" href="#reading-observed-data"></a>
</h3>
<p>We need to supply the observed data which we are going to use to
identify parameter values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="st">"tests/data/AciclovirLaskinData.xlsx"</span></span>
<span><span class="va">dataConfiguration</span> <span class="op">&lt;-</span> <span class="fu">createImporterConfigurationForFile</span><span class="op">(</span>filePath <span class="op">=</span> <span class="va">filePath</span><span class="op">)</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">sheets</span> <span class="op">&lt;-</span> <span class="st">"Laskin 1982.Group A"</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">namingPattern</span> <span class="op">&lt;-</span> <span class="st">"{Source}.{Sheet}"</span></span>
<span><span class="va">observedData</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">dataConfiguration</span><span class="op">)</span></span></code></pre></div>
<p>Here, the <em>importer configuration</em> is created with the
<code>createImporterConfigurationForFile</code> helper function that
tries to guess column names in the Excel file. If you run into errors
while importing the data, try to create the importer configuration from
the PK-Sim GUI, export it as an <code>XML</code> file and re-use it for
importing observed data into R as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="st">"tests/data/AciclovirLaskinData.xlsx"</span></span>
<span><span class="va">dataConfiguration</span> <span class="op">&lt;-</span> <span class="fu">loadDataImporterConfiguration</span><span class="op">(</span><span class="st">"tests/data/dataImporter_configuration.xml"</span><span class="op">)</span></span>
<span><span class="va">observedData</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">dataConfiguration</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mapping-data-to-model-outputs">Mapping data to model outputs<a class="anchor" aria-label="anchor" href="#mapping-data-to-model-outputs"></a>
</h3>
<p>Typically, the observed data show the concentration of the compound
in the peripheral blood flow, but there can be other setups. A class
from the package that matches the model outputs and the observations is
called <code>PIOutputMapping</code>, for example:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputMapping</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIOutputMapping.html">PIOutputMapping</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>quantity <span class="op">=</span> <span class="fu">getQuantity</span><span class="op">(</span><span class="st">"Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"</span>,</span>
<span>  container <span class="op">=</span> <span class="va">simulations</span><span class="op">$</span><span class="va">Aciclovir</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputMapping</span><span class="op">$</span><span class="fu">addObservedDataSets</span><span class="op">(</span><span class="va">observedData</span><span class="op">$</span><span class="va">`AciclovirLaskinData.Laskin 1982.Group A`</span><span class="op">)</span></span>
<span><span class="va">outputMapping</span><span class="op">$</span><span class="va">scaling</span> <span class="op">&lt;-</span> <span class="st">"lin"</span></span>
<span><span class="va">outputMappings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">outputMapping</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-parameter-estimation">Running parameter estimation<a class="anchor" aria-label="anchor" href="#running-parameter-estimation"></a>
</h3>
<p>After the <code>outputMappings</code>, <code>simulations</code>,
<code>parameters</code> and <code>piConfiguration</code> objects are
created, they are used in an instance of the
<code>ParameterIdentification</code> class as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParameterIdentification.html">ParameterIdentification</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  simulations <span class="op">=</span> <span class="va">simulations</span>,</span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  outputMappings <span class="op">=</span> <span class="va">outputMappings</span>,</span>
<span>  configuration <span class="op">=</span> <span class="va">piConfiguration</span></span>
<span><span class="op">)</span></span>
<span><span class="va">taskResults</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If <code>piConfiguration$printEvaluationFeedback</code> is set to
<code>TRUE</code>, each iteration will print a single line with the
current objective function value, to track the performance of the
optimization algorithm, such as below:</p>
<pre><code><span><span class="co">#&gt; Running optimization algorithm: BOBYQA</span></span>
<span><span class="co">#&gt; fneval 1: parameters -0.097, target function 778</span></span>
<span><span class="co">#&gt; fneval 2: parameters -0.097, target function 778</span></span>
<span><span class="co">#&gt; fneval 3: parameters -0.097, target function 778</span></span>
<span><span class="co">#&gt; fneval 4: parameters 4.9, target function 869</span></span>
<span><span class="co">#&gt; fneval 5: parameters -5.1, target function 5650</span></span>
<span><span class="co">#&gt; fneval 6: parameters 2.31, target function 518</span></span>
<span><span class="co">#&gt; fneval 7: parameters 2.22, target function 468</span></span>
<span><span class="co">#&gt; fneval 8: parameters 2.02, target function 365</span></span>
<span><span class="co">#&gt; fneval 9: parameters 1.64, target function 201</span></span>
<span><span class="co">#&gt; fneval 10: parameters 1.27, target function 157</span></span>
<span><span class="co">#&gt; fneval 11: parameters 1.22, target function 160</span></span>
<span><span class="co">#&gt; fneval 12: parameters 1.31, target function 156</span></span>
<span><span class="co">#&gt; fneval 13: parameters 1.36, target function 157</span></span>
<span><span class="co">#&gt; fneval 14: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 15: parameters 1.31, target function 156</span></span>
<span><span class="co">#&gt; fneval 16: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 17: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 18: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 19: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 20: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 21: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 22: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; Post-hoc estimation of hessian</span></span>
<span><span class="co">#&gt; fneval 23: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 24: parameters 1.32, target function 156</span></span>
<span><span class="co">#&gt; fneval 25: parameters 1.45, target function 163</span></span>
<span><span class="co">#&gt; fneval 26: parameters 1.19, target function 162</span></span>
<span><span class="co">#&gt; fneval 27: parameters 1.38, target function 158</span></span>
<span><span class="co">#&gt; fneval 28: parameters 1.25, target function 158</span></span>
<span><span class="co">#&gt; fneval 29: parameters 1.35, target function 157</span></span>
<span><span class="co">#&gt; fneval 30: parameters 1.29, target function 157</span></span>
<span><span class="co">#&gt; fneval 31: parameters 1.34, target function 156</span></span>
<span><span class="co">#&gt; fneval 32: parameters 1.3, target function 156</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>The resulting object contains:</p>
<ul>
<li>
<code>taskResults$par</code>: a vector of point estimates for each
of the parameters</li>
<li>
<code>taskResults$lwr</code> and <code>taskResults$upr</code>:
vectors with lower bounds and upper bounds for the 95% confidence
interval for each of the parameters</li>
<li>
<code>taskResults$cv</code>: a vector with coefficient of variation
(standard deviation over point estimate, in percents) for each of the
parameters</li>
<li>
<code>taskResults$value</code> is the objective function value at
the point estimate</li>
<li>
<code>taskResults$elapsed</code> (seconds) is the wall time it took
to run the main optimization routine, excluding the hessian
calculations</li>
<li>
<code>taskResults$nrOfFnEvaluations</code> is the number of times
the objective function was evaluated in the main optimization routine,
excluding the hessian calculations</li>
</ul>
<p>The <code>task</code> object also contains a
<code>$plotResults()</code> function that produces three diagnostic
plots: an individual time profile with the current best estimate of
model parameters and overlayed observed data, a comparison of
predicted-vs-observed values and a plot of residuals vs time to identify
potential biases in the model. The <code>$plotResults()</code> function
can take an optional vector of parameter values to plot the curve
corresponding to another set of model parameters. After running the
parameter identification task, the <code>$plotResults()</code> function
can be called as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span><span class="op">$</span><span class="fu">plotResults</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in plotObservedVsSimulated(dataCombined[[idx]], plotConfiguration):</span></span>
<span><span class="co">#&gt; Linear scale is inappropriate when `foldDistance` argument is specified.</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-12-1.png" width="960" style="display: block; margin: auto;"></p>
<p>We can judge if the model is properly calibrated by observing if:</p>
<ul>
<li>the individual time profile is close to the observed data
points</li>
<li>the predicted-vs-observed plot is close to the diagonal</li>
<li>the residuals are randomly distributed above and below zero</li>
</ul>
<p>The residuals only above or only below zero indicate an
overprediction or an underprediction. It is likely that another set of
parameters will result in a better fit. A bad prediction in the
early-time region of the plot indicates that the model needs a better
description of the drug absorption. A bad prediction in the late-time
region indicates that the model needs a better description of the drug
elimination.</p>
</div>
<div class="section level3">
<h3 id="plotting-ofv-profiles">Plotting OFV profiles<a class="anchor" aria-label="anchor" href="#plotting-ofv-profiles"></a>
</h3>
<p>Around the global minimum, the objective function is expected to be
convex and parabolic. We can check if we are, indeed, around a minimum
(global or local) by plotting the objective function value (OFV) profile
around the tentative optimal point. For example, after running the
parameter identification task, run to plot the OFV profile:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">calculateOFVProfiles</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">plotOFVProfiles</span><span class="op">(</span><span class="va">profile</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-15-1.png" width="576" style="display: block; margin: auto;">
We observe that the tentative lipophilicity value of 1.32 is close to at
least a local (and potentially, a global) minimum. By passing explicit
parameters to the <code>calculateOFVProfiles</code> function, we can
check the whole parameter space, at least for 1-dimensional parameter
estimation problems:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">calculateOFVProfiles</span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">10</span>, totalEvaluations <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">plotOFVProfiles</span><span class="op">(</span><span class="va">profile</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="midazolam-model">Midazolam model<a class="anchor" aria-label="anchor" href="#midazolam-model"></a>
</h2>
<div class="section level3">
<h3 id="extracting-parameters-from-the-model-1">Extracting parameters from the model<a class="anchor" aria-label="anchor" href="#extracting-parameters-from-the-model-1"></a>
</h3>
<p>Load the model by running</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piConfiguration</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIConfiguration.html">PIConfiguration</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">piConfiguration</span><span class="op">$</span><span class="va">printEvaluationFeedback</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Smith1981 iv 5mg Midazolam.pkml"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">simulations</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Midazolam"</span></span></code></pre></div>
<p>The midazolam model shipped with this package includes two free
parameters: lipophilicity of midazolam and the catalytic activity of the
CYP3A4 cytochrome in the reaction with midazolam. While lipophilicity is
stored in the model as a <code>Midazolam|Lipophilicity</code> parameter,
the catalytic activity (kcat) is less transparently called
<code>Midazolam-CYP3A4-Patki et al. 2003 rCYP3A4|kcat</code>. However,
we can find it by searching for a parameter name including
<code>kcat</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">getAllParametersMatching</span><span class="op">(</span><span class="st">"**|kcat"</span>, <span class="va">simulations</span><span class="op">$</span><span class="va">Midazolam</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Midazolam-CYP3A4-Patki et al. 2003 rCYP3A4|kcat </span></span>
<span><span class="co">#&gt;    Value: 320.00 [1/min] </span></span>
<span><span class="co">#&gt;    isFormula: TRUE </span></span>
<span><span class="co">#&gt;    formula: InVitroVmaxPerRecombinantEnzyme </span></span>
<span><span class="co">#&gt;    Value overrides formula: FALSE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE</span></span></code></pre></div>
<p>… and then we have everything we need to set up the parameter
identification task.</p>
</div>
<div class="section level3">
<h3 id="setting-up-the-model">Setting up the model<a class="anchor" aria-label="anchor" href="#setting-up-the-model"></a>
</h3>
<p>Execute the following code to continue setting up the midazolam model
and to run the task.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameterInputData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Midazolam|Lipophilicity"</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, max <span class="op">=</span> <span class="fl">10</span>, start <span class="op">=</span> <span class="fl">3.9</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Midazolam-CYP3A4-Patki et al. 2003 rCYP3A4|kcat"</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">3200</span>, start <span class="op">=</span> <span class="fl">320</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameterInputData</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">parameterInputData</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">modelParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">simulation</span> <span class="kw">in</span> <span class="va">simulations</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">modelParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modelParams</span>, <span class="fu">ospsuite</span><span class="fu">::</span><span class="fu"><a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/getParameter.html" class="external-link">getParameter</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">path</span>,</span>
<span>      container <span class="op">=</span> <span class="va">simulation</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">modelParams</span><span class="op">)</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">min</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">max</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">startValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">start</span></span>
<span><span class="op">}</span></span>
<span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="st">"tests/data/Midazolam_Smith_1981.xlsx"</span></span>
<span><span class="va">dataConfiguration</span> <span class="op">&lt;-</span> <span class="fu">createImporterConfigurationForFile</span><span class="op">(</span>filePath <span class="op">=</span> <span class="va">filePath</span><span class="op">)</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">sheets</span> <span class="op">&lt;-</span> <span class="st">"Smith1981"</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">namingPattern</span> <span class="op">&lt;-</span> <span class="st">"{Source}.{Sheet}"</span></span>
<span><span class="va">observedData</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">dataConfiguration</span><span class="op">)</span></span>
<span><span class="va">outputMapping</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIOutputMapping.html">PIOutputMapping</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>quantity <span class="op">=</span> <span class="fu">getQuantity</span><span class="op">(</span><span class="st">"Organism|PeripheralVenousBlood|Midazolam|Plasma (Peripheral Venous Blood)"</span>,</span>
<span>  container <span class="op">=</span> <span class="va">simulations</span><span class="op">$</span><span class="va">Midazolam</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputMapping</span><span class="op">$</span><span class="fu">addObservedDataSets</span><span class="op">(</span><span class="va">observedData</span><span class="op">$</span><span class="va">Midazolam_Smith_1981.Smith1981</span><span class="op">)</span></span>
<span><span class="va">outputMapping</span><span class="op">$</span><span class="va">scaling</span> <span class="op">&lt;-</span> <span class="st">"lin"</span></span>
<span><span class="va">outputMappings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">outputMapping</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParameterIdentification.html">ParameterIdentification</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  simulations <span class="op">=</span> <span class="va">simulations</span>,</span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  outputMappings <span class="op">=</span> <span class="va">outputMapping</span>,</span>
<span>  configuration <span class="op">=</span> <span class="va">piConfiguration</span></span>
<span><span class="op">)</span></span>
<span><span class="va">taskResults</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ofv-grids-for-parameter-space-exploration">OFV grids for parameter space exploration<a class="anchor" aria-label="anchor" href="#ofv-grids-for-parameter-space-exploration"></a>
</h3>
<p>In addition to previous diagnostic methods, we can also plot the
landscape of the objective function, since the problem is 2-parametric
and it is easily visualized with a contour plot. The package includes
<code>$gridSearch()</code> and <code>$plotGrid()</code> functions for
that:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">gridSearch</span><span class="op">(</span>lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span><span class="op">)</span>, upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span>, totalEvaluations <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">plotOFVGrid</span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-23-1.png" width="960" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="clarithromycin-model">Clarithromycin model<a class="anchor" aria-label="anchor" href="#clarithromycin-model"></a>
</h2>
<div class="section level3">
<h3 id="setting-up-the-model-1">Setting up the model<a class="anchor" aria-label="anchor" href="#setting-up-the-model-1"></a>
</h3>
<p>This is a more complex model that lifts its observed data from five
distinct studies and includes three parameters that should be optimized.
Load the simulations, the parameters, the observed data and the task by
running the following code:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"IV250"</span> <span class="op">=</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Chu1992 iv 250mg Clarithromycin.pkml"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PO250"</span> <span class="op">=</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Chu1993 po 250mg Clarithromycin.pkml"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PO250MD"</span> <span class="op">=</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Chu1993 po 250mg md Clarithromycin.pkml"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PO500"</span> <span class="op">=</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Chu1993 po 500mg Clarithromycin.pkml"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PO500MD"</span> <span class="op">=</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="st">"tests/dev/Models/Simulations/Chu1993 po 500mg md Clarithromycin.pkml"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">piConfiguration</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIConfiguration.html">PIConfiguration</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameterInputData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Clarithromycin-CYP3A4-fit|kcat"</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">100</span>, start <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Neighborhoods|Kidney_pls_Kidney_ur|Clarithromycin|Renal Clearances-fitted|Specific clearance"</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">100</span>, start <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Clarithromycin|Specific intestinal permeability (transcellular)"</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span>, start <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameterInputData</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">parameterInputData</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">modelParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">simulation</span> <span class="kw">in</span> <span class="va">simulations</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">modelParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modelParams</span>, <span class="fu">ospsuite</span><span class="fu">::</span><span class="fu"><a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/getParameter.html" class="external-link">getParameter</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">path</span>,</span>
<span>      container <span class="op">=</span> <span class="va">simulation</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">modelParams</span><span class="op">)</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">min</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">max</span></span>
<span>  <span class="va">parameters</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">startValue</span> <span class="op">&lt;-</span> <span class="va">parameterInputData</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">start</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Observed data is loaded from two different files</span></span>
<span><span class="co"># because IV data is reported in µmol/L, and PO data is reported in µg/ml</span></span>
<span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="st">"tests/data/Clarithromycin_Chu_1992.xlsx"</span></span>
<span><span class="va">dataConfiguration</span> <span class="op">&lt;-</span> <span class="fu">createImporterConfigurationForFile</span><span class="op">(</span>filePath <span class="op">=</span> <span class="va">filePath</span><span class="op">)</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">sheets</span> <span class="op">&lt;-</span> <span class="st">"IV250"</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">namingPattern</span> <span class="op">&lt;-</span> <span class="st">"{Sheet}"</span></span>
<span><span class="va">observedData_IV</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">dataConfiguration</span><span class="op">)</span></span>
<span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="st">"tests/data/Clarithromycin_Chu_1993.xlsx"</span></span>
<span><span class="va">dataConfiguration</span> <span class="op">&lt;-</span> <span class="fu">createImporterConfigurationForFile</span><span class="op">(</span>filePath <span class="op">=</span> <span class="va">filePath</span><span class="op">)</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">sheets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PO250"</span>, <span class="st">"PO250MD"</span>, <span class="st">"PO500"</span>, <span class="st">"PO500MD"</span><span class="op">)</span></span>
<span><span class="va">dataConfiguration</span><span class="op">$</span><span class="va">namingPattern</span> <span class="op">&lt;-</span> <span class="st">"{Sheet}"</span></span>
<span><span class="va">observedData_PO</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">dataConfiguration</span><span class="op">)</span></span>
<span><span class="va">observedData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">observedData_IV</span>, <span class="va">observedData_PO</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outputMappings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">simulations</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">simulations</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">outputMappings</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIOutputMapping.html">PIOutputMapping</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>quantity <span class="op">=</span> <span class="fu">getQuantity</span><span class="op">(</span><span class="st">"Organism|PeripheralVenousBlood|Clarithromycin|Plasma (Peripheral Venous Blood)"</span>,</span>
<span>                                                                      container <span class="op">=</span> <span class="va">simulations</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">outputMappings</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">addObservedDataSets</span><span class="op">(</span><span class="va">observedData</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">simulations</span><span class="op">)</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">outputMappings</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">scaling</span> <span class="op">&lt;-</span> <span class="st">"lin"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParameterIdentification.html">ParameterIdentification</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  simulations <span class="op">=</span> <span class="va">simulations</span>,</span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  outputMappings <span class="op">=</span> <span class="va">outputMappings</span>,</span>
<span>  configuration <span class="op">=</span> <span class="va">piConfiguration</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="limitations-of-the-local-optimization-algorithms">Limitations of the local optimization algorithms<a class="anchor" aria-label="anchor" href="#limitations-of-the-local-optimization-algorithms"></a>
</h3>
<p>The solution (catalytic activity 14.10 1/min, specific clearance 6.24
1/min, intestinal permeability 1.306e-6 dm/min, OFV 4.17) found by the
BOBYQA algorithm with the default parameters is satisfactory, because
the individual profiles are close to the observed data. However, it is
sub-optimal, as can be evidenced by non-parabolic OFV profiles:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taskResults</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">plotOFVProfiles</span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">calculateOFVProfiles</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-26-1.png" width="576" style="display: block; margin: auto;"></p>
<p>If a sub-optimal solution is not enough, we need to use grid search
or a global stochastic optimization algorithm, such as differential
evolution, to find a good starting approximation or a global
minimum.</p>
</div>
<div class="section level3">
<h3 id="exhaustive-grid-search">Exhaustive grid search<a class="anchor" aria-label="anchor" href="#exhaustive-grid-search"></a>
</h3>
<p>Running the grid search can be a useful first step when you don’t
know the optimization landscape of the problem.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">gridSearch</span><span class="op">(</span>totalEvaluations <span class="op">=</span> <span class="fl">1000</span>, setStartingPoint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">best</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="va">grid</span>, <span class="va">ofv</span>, with_ties <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>If the <code>setStartingPoint</code> argument is set to
<code>TRUE</code> (instead of default <code>FALSE</code>), the next
optimization run will start from the best estimate across the grid.</p>
</div>
<div class="section level3">
<h3 id="running-a-global-optimization-algorithm">Running a global optimization algorithm<a class="anchor" aria-label="anchor" href="#running-a-global-optimization-algorithm"></a>
</h3>
<p>Running 1000 iterations of differential optimization produces a
result with a better OFV: catalytic activity 45.7 1/min, specific
clearance 1.43 1/min, intestinal permeability 1.256e-6 dm/min, OFV
1.96.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span><span class="op">$</span><span class="va">configuration</span><span class="op">$</span><span class="va">algorithm</span> <span class="op">&lt;-</span> <span class="st">"DEoptim"</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="va">configuration</span><span class="op">$</span><span class="va">algorithmOptions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>itermax <span class="op">=</span> <span class="fl">1000</span>, steptol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">taskResults</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We can ensure that this is at least a local minimum by plotting the
OFV profiles:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span><span class="op">$</span><span class="fu">plotOFVProfiles</span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">calculateOFVProfiles</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-30-1.png" width="576" style="display: block; margin: auto;"><img src="user-guide_files/figure-html/unnamed-chunk-30-2.png" width="576" style="display: block; margin: auto;"><img src="user-guide_files/figure-html/unnamed-chunk-30-3.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Pavel Balazki, Sergei Vavilov.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
